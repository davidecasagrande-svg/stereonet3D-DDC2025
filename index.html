<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Plane & Pole Viewer (Dip / Dip Direction)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Three.js r128 + examples from UNPKG (more reliable for examples) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>

  <style>
    :root { --panel:#111827; --muted:#6b7280; --border:#1f2937; }
    html,body{height:100%;margin:0;background:#ffffff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;overflow:hidden}
    .wrap{display:grid;grid-template-columns:340px 1fr;height:100%;}
    .panel{background:var(--panel);color:#fff;padding:14px;border-right:1px solid var(--border);overflow:auto}
    h1{font-size:18px;margin:4px 0 12px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px}
    th,td{border-bottom:1px solid var(--border);padding:6px 4px;text-align:left}
    input[type="number"],input[type="text"]{background:#0b1220;color:#fff;border:1px solid var(--border);border-radius:6px;padding:4px 6px}
    input[type="number"]{width:72px} input[type="text"]{width:80px}
    input[type="color"]{width:36px;height:28px;border:none;background:transparent}
    button{background:#1d4ed8;color:#fff;border:none;border-radius:8px;padding:8px 10px;font-weight:600;cursor:pointer}
    button.secondary{background:#334155}
    button.ghost{background:transparent;border:1px solid var(--border);color:#e5e7eb}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .inline{display:flex;gap:8px;align-items:center;margin-top:6px}
    #canvasWrap{position:relative}
    #webgl{display:block;width:100%;height:100%}
    .label{color:#fff;font-size:14px;padding:2px 6px;background:rgba(0,0,0,.55);border-radius:6px;pointer-events:none}
    .legend{margin-top:8px;border:1px solid var(--border);border-radius:10px;padding:8px;color:#e5e7eb}
    .legend-item{display:flex;align-items:center;gap:8px;margin:4px 0}
    .swatch{width:14px;height:14px;border-radius:3px;border:1px solid #0003}
    .small{font-size:12px}
    #webgl canvas{touch-action:none}
    .label-layer{pointer-events:none}
  </style>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <h1>3D Plane & Pole Viewer</h1>
    <div class="muted small">Enter Dip (°) and Dip Direction (°). Add as many rows as you need. Plot draws <b>all</b> poles together. Click a pole to highlight or solo its plane.</div>

    <div class="btnrow">
      <button id="addRowBtn">+ Add Plane</button>
      <button id="plotBtn">Plot / Update</button>
      <button id="resetBtn" class="secondary">Reset View</button>
      <button id="downloadBtn" class="ghost">Download PNG</button>
    </div>

    <div class="inline small">
      <label><input type="checkbox" id="soloToggle"> Solo selected plane on click</label>
      <label><input type="checkbox" id="gridToggle" checked> Show wireframe sphere</label>
    </div>

    <table id="planesTable">
      <thead><tr><th>Label</th><th>Dip</th><th>Dip Dir</th><th>Colour</th><th></th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="legend" id="legendBox">
      <div class="small muted" style="color:#9ca3af">Legend</div>
      <div id="legendItems"></div>
    </div>

    <div class="small muted" style="margin-top:8px;color:#9ca3af">
      Axes: X=East, Y=North, Z=Up. N/E/S/W labels are fixed in world space and rotate with the sphere.
    </div>
  </aside>

  <section id="canvasWrap"><div id="webgl"></div></section>
</div>

<script>
/* ---------- UI state ---------- */
const RADIUS = 100;
const tbody = document.getElementById('tbody');
const legendItems = document.getElementById('legendItems');
const addRowBtn = document.getElementById('addRowBtn');
const plotBtn = document.getElementById('plotBtn');
const resetBtn = document.getElementById('resetBtn');
const downloadBtn = document.getElementById('downloadBtn');
const soloToggle = document.getElementById('soloToggle');
const gridToggle = document.getElementById('gridToggle');

[{label:'ID_1',dip:60,dipDir:340,color:'#ff3b30'},
 {label:'ID_2',dip:75,dipDir:240,color:'#34c759'},
 {label:'ID_3',dip:85,dipDir:200,color:'#0a84ff'}].forEach(addRow);
if (!tbody.children.length) addRow();

addRowBtn.onclick=()=>addRow();
plotBtn.onclick = ()=>buildSceneFromTable();
resetBtn.onclick=()=>resetView();
downloadBtn.onclick=()=>downloadPNG();
gridToggle.onchange=()=>{ if (wire) wire.visible = gridToggle.checked; };

function addRow(row={label:'ID_'+(tbody.children.length+1),dip:'',dipDir:'',color:'#ff6b00'}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" value="${row.label}"></td>
    <td><input type="number" min="0" max="90" step="0.1" value="${row.dip}"></td>
    <td><input type="number" min="0" max="360" step="0.1" value="${row.dipDir}"></td>
    <td><input type="color" value="${row.color}"></td>
    <td><button class="ghost small" onclick="this.closest('tr').remove()">✕</button></td>`;
  tbody.appendChild(tr);
}
function readRows(){
  const rows=[];
  [...tbody.children].forEach(tr=>{
    const [lab,dip,dd,col]=tr.querySelectorAll('input');
    const d=parseFloat(dip.value), dir=parseFloat(dd.value);
    if (isFinite(d)&&isFinite(dir))
      rows.push({label:lab.value||'Set', dip:d, dipDir:((dir%360)+360)%360, color:col.value||'#ffffff'});
  });
  return rows;
}

/* ---------- Three.js ---------- */
let scene,camera,renderer,controls,labelRenderer,wire;
let poles=[],rings=[],fills=[],poleGroup,planeGroup,clickables=[];
let compass;
const HIGHLIGHT_RING=0.9, NORMAL_RING=0.35, FADE_RING=0.10, FILL_ALPHA=0.25;
let selected=-1;

const container=document.getElementById('webgl');
init(); buildSceneFromTable();

function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0xffffff);

  const w=container.clientWidth||window.innerWidth-340;
  const h=window.innerHeight;
  camera=new THREE.PerspectiveCamera(50,w/h,0.1,2000);
  camera.position.set(0,0,RADIUS*3);

  renderer=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});
  renderer.setSize(w,h); container.appendChild(renderer.domElement);

  labelRenderer=new THREE.CSS2DRenderer();
  labelRenderer.setSize(w,h);
  labelRenderer.domElement.style.position='absolute';
  labelRenderer.domElement.style.top='0';
  labelRenderer.domElement.className='label-layer';
  container.appendChild(labelRenderer.domElement);

  controls=new THREE.OrbitControls(camera,renderer.domElement);
  controls.enableDamping=true; controls.dampingFactor=0.06;
  controls.minDistance=RADIUS*1.3; controls.maxDistance=RADIUS*6;

  scene.add(new THREE.AmbientLight(0xffffff,0.9));
  const dLight=new THREE.DirectionalLight(0xffffff,0.8);
  dLight.position.set(200,200,200); scene.add(dLight);

  const axes=new THREE.AxesHelper(RADIUS*1.2); scene.add(axes);

  compass=new THREE.Group();
  const mkLbl=(t,p)=>{const el=document.createElement('div'); el.className='label'; el.textContent=t;
                      const obj=new THREE.CSS2DObject(el); obj.position.copy(p); compass.add(obj);};
  mkLbl('N', new THREE.Vector3(0, RADIUS*1.05, 0));
  mkLbl('S', new THREE.Vector3(0,-RADIUS*1.05, 0));
  mkLbl('E', new THREE.Vector3( RADIUS*1.05,0,0));
  mkLbl('W', new THREE.Vector3(-RADIUS*1.05,0,0));
  scene.add(compass);

  const sph=new THREE.SphereGeometry(RADIUS,24,18);
  const wireMat=new THREE.MeshBasicMaterial({color:0xcbd5e1,wireframe:true,transparent:true,opacity:0.4});
  wire=new THREE.Mesh(sph,wireMat); scene.add(wire);

  poleGroup=new THREE.Group(); planeGroup=new THREE.Group();
  scene.add(planeGroup); scene.add(poleGroup);

  window.addEventListener('resize', onResize);
  renderer.domElement.addEventListener('pointerdown', onPick);
  animate();
}
function onResize(){
  const w=container.clientWidth||window.innerWidth-340, h=window.innerHeight;
  camera.aspect=w/h; camera.updateProjectionMatrix();
  renderer.setSize(w,h); labelRenderer.setSize(w,h);
}
function animate(){ requestAnimationFrame(animate); controls.update();
  renderer.render(scene,camera); labelRenderer.render(scene,camera); }

/* ---------- Build scene ---------- */
function buildSceneFromTable(){
  // clear old
  poleGroup.clear(); planeGroup.clear();
  poles=[]; rings=[]; fills=[]; clickables=[]; legendItems.innerHTML='';

  const rows=readRows(); if(!rows.length) return;

  rows.forEach((r,idx)=>{
    const color=new THREE.Color(r.color);
    const v=poleVector(r.dipDir,r.dip).normalize().multiplyScalar(RADIUS);

    const pole=new THREE.Mesh(
      new THREE.SphereGeometry(2.8,16,16),
      new THREE.MeshStandardMaterial({color,roughness:0.3,metalness:0.1})
    );
    pole.position.copy(v);
    pole.userData={index:idx,label:r.label,dip:r.dip,dipDir:r.dipDir,color:r.color};
    poleGroup.add(pole); poles.push(pole); clickables.push(pole);

    const q=new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0,0,1), v.clone().normalize());

    // Great-circle ring (always visible)
    const ring=new THREE.Mesh(
      new THREE.RingGeometry(RADIUS-0.3,RADIUS+0.3,256),
      new THREE.MeshBasicMaterial({color,transparent:true,opacity:NORMAL_RING,side:THREE.DoubleSide})
    );
    ring.quaternion.copy(q); planeGroup.add(ring); rings.push(ring);

    // Filled plane (hidden until selected)
    const fill=new THREE.Mesh(
      new THREE.PlaneGeometry(RADIUS*2.2, RADIUS*2.2, 1, 1),
      new THREE.MeshStandardMaterial({color,transparent:true,opacity:FILL_ALPHA,side:THREE.DoubleSide})
    );
    fill.quaternion.copy(q); fill.visible=false;
    planeGroup.add(fill); fills.push(fill);

    // legend
    const item=document.createElement('div');
    item.className='legend-item';
    item.innerHTML=`<span class="swatch" style="background:${r.color}"></span>
      <span>${r.label}</span>
      <span class="muted small" style="color:#cbd5e1">— Dip ${r.dip.toFixed(1)}°, DipDir ${r.dipDir.toFixed(1)}°</span>`;
    legendItems.appendChild(item);
  });

  clearHighlight();
}
function poleVector(dipDirDeg,dipDeg){
  const trend=THREE.MathUtils.degToRad(dipDirDeg);
  const plunge=THREE.MathUtils.degToRad(90-dipDeg);
  const x=Math.cos(plunge)*Math.sin(trend), y=Math.cos(plunge)*Math.cos(trend), z=-Math.sin(plunge);
  const v=new THREE.Vector3(x,y,z); if(v.z>0) v.negate(); return v;
}

/* ---------- Picking / highlight ---------- */
const raycaster=new THREE.Raycaster(), mouse=new THREE.Vector2();
function onPick(ev){
  const r=renderer.domElement.getBoundingClientRect();
  mouse.x=((ev.clientX-r.left)/r.width)*2-1; mouse.y=-((ev.clientY-r.top)/r.height)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(clickables,false);
  if(hits.length){ const idx=hits[0].object.userData.index;
    if(soloToggle.checked) solo(idx); else highlight(idx);
  } else clearHighlight(true);
}

function highlight(idx){
  selected=idx;
  rings.forEach((ring,i)=>{
    ring.material.opacity = (i===idx)? NORMAL_RING : FADE_RING;
    ring.material.needsUpdate = true;
  });
  fills.forEach((pl,i)=> pl.visible = (i===idx));         // show filled plane only for selected
  poles.forEach((p,i)=> { p.scale.setScalar(i===idx?1.6:1.0); p.visible = true; });
}
function clearHighlight(resetSolo=false){
  selected=-1;
  rings.forEach(r=>{ r.visible=true; r.material.opacity=NORMAL_RING; });
  fills.forEach(f=> f.visible=false);
  poles.forEach(p=> { p.scale.setScalar(1.0); p.visible=true; });
  if(resetSolo) soloToggle.checked=false;
}
function solo(idx){
  selected=idx;
  rings.forEach((r,i)=> r.visible=(i===idx));
  fills.forEach((f,i)=> f.visible=(i===idx));
  poles.forEach((p,i)=> p.visible=(i===idx));
}

/* ---------- Utilities ---------- */
function resetView(){ controls.reset(); camera.position.set(0,0,RADIUS*3); clearHighlight(true); }
function downloadPNG(){ const a=document.createElement('a'); a.download='stereonet3D.png';
  a.href=renderer.domElement.toDataURL('image/png'); a.click(); }
</script>
</body>
</html>
